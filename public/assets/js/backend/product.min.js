var ComponentsIonSliders = function() {
    var handleBasicDemo = function() {
        // demo 1
        $("#price_range").ionRangeSlider({
            type: "double",
            grid: true,
            min: 0,
            max: 10000000,
            from: 0,
            postfix: "đ"
        });
    }
    return {
        //main function to initiate the module
        init: function() {
            handleBasicDemo();
        }
    };
}();

$(document).ready(function(){
	//CKEDITOR.replace( 'description-editor' );
	ComponentsIonSliders.init();

	function handleImage(e) {
	    var reader = new FileReader();
	    reader.onload = function (event) {
	        $('.uploader img').attr('src',event.target.result);
	    }
	    reader.readAsDataURL(e.target.files[0]);
	}

	$('#add-product-form').livequery('submit', function(e) {
        var elem = $('#add-product-form');
        e.preventDefault();
        var data = new FormData(elem[0]);
        var ins = document.getElementById('product-imgs-upload').files.length;
        for (var x = 0; x < ins; x++) {
            data.append("thumb[]", document.getElementById('product-imgs-upload').files[x]);
        } 
        elem.block();
        $.ajax({
        	url: 'product/add-or-update-product',
        	type: 'POST',
        	dataType: 'json',
        	headers: { 'X-CSRF-Token' : $('meta[name=__public_token]').attr('content') },
        	processData: false,
        	contentType: false,
        	data: data
        })
        .done(function(data) {
        	if(data.code == 200){
        		swal({
				  title: "Tuyệt vời!",
				  type: "success",
				  text: 'Bạn đã thêm thành công.',
				  timer: 2000,
				  showConfirmButton: false
				});
        		window.location.reload();
        	}
            else{
                swal('Thất bại', "Có lỗi xảy ra trong quá trình thêm");
            }        	
        })
        .fail(function() {
        })
        .always(function() {
        	elem.unblock();
        });
    });

  	$('.deleteProduct').livequery('click',function(e){
  		e.preventDefault();
  		var elem = $(this);
  		var id = elem.attr('data-id');
  		if (typeof id !== 'undefined') {
  			swal({
	          title: "Bạn có chắc chắn?",
	          text: "Sản phẩm sẽ không thể phục hồi sau khi đã được xoá!",
	          type: "warning",
	          showCancelButton: true,
	          confirmButtonColor: "#DD6B55",
	          confirmButtonText: "Xoá",
	          closeOnConfirm: false
	        },
	        function(){
	            $.ajax({
	                url: 'product',
	                type: 'DELETE',
	                headers: { 'X-CSRF-Token' : $('meta[name=__public_token]').attr('content') },
	                dataType: 'json',
	                data: {id: id},
	            })
	            .done(function(data) {
	                if (data.code == 200){
	                    swal("Deleted!", data.message, "success");
	                    window.location.reload();
	                }
	                //swal("Opps!", "Xoá chưa thành công", "error");
	            })
	            .fail(function() {
	                console.log("error");
	            })
	            .always(function() {
	                console.log("complete");
	            });
	        });
  		}
  	});

	$('.editProduct').livequery('click',function(){
    	var elem = $(this);
    	var id = elem.attr('data-id');
    	elem.block();
    	$.ajax({
    		url: 'product/find-product',
    		type: 'GET',
    		data: {
    			id: id
    		}
    	})
    	.done(function(data) {
    		$('<div class="modal fade" id="modalEdit">' + data + '</div>').modal();
    	})
    	.fail(function() {
    		console.log("error");
    	})
    	.always(function() {
            elem.unblock();
    	});
    });

    $('#edit-product-form').livequery('submit', function(e) {
        var elem = $(this);
        e.preventDefault();
        var data = new FormData(elem[0]);
        var ins = document.getElementById('product-imgs-upload').files.length;
        for (var x = 0; x < ins; x++) {
            data.append("thumb", document.getElementById('product-imgs-upload-edit').files[x]);
        } 
        elem.block();
        $.ajax({
        	url: 'product/add-or-update-product',
        	type: 'POST',
        	dataType: 'json',
        	processData: false,
    		contentType: false,
        	data: data,
        })
        .done(function(data) {
        	if(data.code == 200){
        		swal({
				  title: "Tuyệt vời!",
				  type: "success",
				  text: 'Cập nhật thành công.',
				  timer: 3000,
				  showConfirmButton: false
				});
        		window.location.reload();
        	}
            else{
                swal('Thất bại', "Có lỗi xảy ra trong quá trình cập nhật");
            }        	
        })
        .fail(function() {
        	swal('Thất bại', 'Cập nhật chưa thành công');
        })
        .always(function() {
        	elem.unblock();
        });
    });

    $('.ckeditor').each(function(e){
    	//if (!CKEDITOR.instances[this.id]) {
    		CKEDITOR.replace( this.id );
    	//}
    });

    $(".bs-select").selectpicker({iconBase:"fa",tickIcon:"fa-check"});

    $("#form-import-excel").livequery('submit',function(e){
    	e.preventDefault();
    	var elem = $('#input-import-excel');
    	var file_data = elem.prop('files')[0];
        var file_name = elem.val();
        var inputData = new FormData($(this)[0]);
        var form_data = new FormData();
        form_data.append('file', file_data);
        form_data.append('file_name', file_name);
    	$.ajax({
        	url: 'product/import-excel',
        	method: 'POST',
        	async: false,
        	headers: { 'X-CSRF-Token' : $('meta[name=__public_token]').attr('content') },
    		dataType: 'json',
        	processData: false,
    		contentType: false,
    		//contentType: false,
    		data : inputData
        })
        .done(function(data) {
        	if (data["code"] == 200) {
        		swal({
				  title: "Tuyệt vời!",
				  type: "success",
				  text: data['message'],
				  timer: 3000,
				  showConfirmButton: false
				});
				window.location.reload();
        	}
        })
        .fail(function() {
        	swal('Thất bại', 'Cập nhật chưa thành công');
        })
        .always(function() {
        	elem.unblock();
        });
    })
});